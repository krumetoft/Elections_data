---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(dbplyr)
library(pander)
source("utils.R")
```

```{r}
#Links to files
parties_link_july <-'https://raw.githubusercontent.com/krumeto/Elections_data/main/elections/elections_2021_july/cik_parties_11.07.2021.txt'
sections_link_july <- 'https://raw.githubusercontent.com/krumeto/Elections_data/main/elections/elections_2021_july/sections_11.07.2021.txt'
votes_link_july <- "https://raw.githubusercontent.com/krumeto/Elections_data/main/elections/elections_2021_july/votes_11.07.2021.txt"
elections <- 'july'

#Read Sections, Parties and Votes
sections_july <- read_sections_table(sections_link_july)
parties_july <- read_parties_table(parties_link_july)
votes_july  <- finalize_votes_df(votes_link_july, parties_july, elections)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 
```{r}
votes_july %>% 
  group_by(party_index) %>% 
  summarize(sum_votes = sum(votes_count, na.rm = TRUE)) %>% 
  arrange(desc(sum_votes)) %>% 
  left_join(parties_july, by = "party_index") %>% # Any better way of mapping an index to party? 
  select(party_index, party_name, sum_votes) %>% 
  pander() #Just more readable printout of the table

```

```{r}
parties_july %>% pander()
```


```{r}
votes_july %>% 
  group_by(party_index) %>% 
  summarize(sum_votes = sum(votes_count, na.rm = TRUE)) %>% 
  arrange(desc(sum_votes)) %>% 
  left_join(parties_july, by = "party_index") %>% # Any better way of mapping an index to party? 
  select(party_index, party_name, party_alias, sum_votes) %>% 
  ggplot(mapping = aes(x=party_alias, y=sum_votes)) +
  geom_bar(stat='identity') +
#  geom_text(aes(label = sum_votes)) +
#  scale_x_discrete(breaks = seq(1:23), labels = seq(1:23)) +
  coord_flip() 
 # theme(legend.position = 'none')
```
```{r}
#Links to files
parties_link_april <-'https://raw.githubusercontent.com/krumeto/Elections_data/main/elections/elections_2021_april/cik_parties_04.04.2021.txt'
sections_link_april <- 'https://raw.githubusercontent.com/krumeto/Elections_data/main/elections/elections_2021_april/sections_04.04.2021.txt'
votes_link_april <- "https://raw.githubusercontent.com/krumeto/Elections_data/main/elections/elections_2021_april/votes_04.04.2021.txt"

elections <- 'april'

#Read Sections, Parties and Votes
sections_april <- read_sections_table(sections_link_april)
parties_april <- read_parties_table(parties_link_april)
votes_april <- finalize_votes_df(votes_link_april, parties_april, elections)


```
```{r}
votes_april %>% 
  group_by(party_index) %>% 
  summarize(sum_votes = sum(votes_count, na.rm = TRUE)) %>% 
  arrange(desc(sum_votes)) %>% 
  left_join(parties_july, by = "party_index") %>% # Any better way of mapping an index to party? 
  select(party_index, party_name, sum_votes) %>% 
  pander() #Just more readable printout of the table

```

```{r}
t <- read_prep_votes_table(votes_link_april, parties_april, elections='april')

party <- parties_april$party_name[1]
party

# t %>% 
#   select(contains(party)) %>% 
#   rename(party_index := !!party) %>% 
#   rename(votes_count := !!paste(party, "_votes", sep='')) 
#   # rename(party_index := !!party) %>% 
#   # rename(votes_count := !!paste(party, "_votes", sep='')) 
# 
#  t %>% head() %>% View()
# party <- parties$party_name[1]
# party
# 
# extract_votes_per_party(t, party) %>%
#   head() %>%
#   glimpse()

```


```{r}
votes <- read.delim(votes_link, 
                      sep=";", 
                      encoding = "UTF-8",
                      header = FALSE
  )


names(votes)[1] <- 'section_code'
names(votes)[2] <- 'identificator_administrative_entity'

party_name_col_numbers <- seq(3,126,4)
party_total_votes_col_numbers <- seq(4,126,4)
party_votes_paper_col_numbers <- seq(5,126,4)
party_votes_machines_col_numbers <- seq(6,126,4)


names(votes)[grepl("V", names(votes)) & parse_number(names(votes)) %in% party_name_col_numbers] <- parties$party_name
names(votes)[grepl("V", names(votes)) & parse_number(names(votes)) %in% party_total_votes_col_numbers] <- paste(parties$party_name, "_votes", sep='')
names(votes)[grepl("V", names(votes)) & parse_number(names(votes)) %in% party_votes_paper_col_numbers] <- paste(parties$party_name, "_paper_votes", sep='')
names(votes)[grepl("V", names(votes)) & parse_number(names(votes)) %in% party_votes_machines_col_numbers] <- paste(parties$party_name, "_machine_votes", sep='')

votes %>% head() %>% View()

# names(votes)[grepl("V", names(votes)) & parse_number(names(votes)) %% 2 == 0] <- party_df$party_name
# names(votes)[grepl("V", names(votes)) & parse_number(names(votes)) %% 2 == 1] <- paste(party_df$party_name, "_votes", sep='')
```

```{r}

```




```{r}
library(dplyr)
options(scipen=20)
connection <- ftdata_connection(billing = "ft-data-science")

ftbbqr::source_bq_tbl(connection = connection, 
                      dataset = "ft-data-science",
                      schema = 'historic',
                      table = 'b2b_contract_ltv'
                      ) %>% 
  filter(between(run_date, '2021-08-01', '2021-08-04')) %>% #ftbbqr::partitiontime_between()
  select(total_core_readers) %>% 
  sql_render() 
  
  

```

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


